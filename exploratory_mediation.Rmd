---
title: "Exploratory mediation"
author: "Megan Sears"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: journal
editor_options:
  chunk_output_type: console
---

```{r, include = F}

library(pacman)

p_load(here, 
       regsem, 
       semPlot, 
       caret, 
       ggh4x, 
       ggdag, 
       tidyverse, 
       ggsankeyfier, 
       reshape, 
       networkD3, 
       igraph, 
       ggraph, 
       ggridges,
       glmnet)

```

# Prep

```{r}

response <- read_csv('./data/final_model_inputs/events_inputs.csv') %>%
  select(site,
         sp_cat,
         fire,
         stage_rise_cm,
         lag2peak_halfP,
         lag2peak_Pstart,
         MI60_mmhr,
         lag_pwd,
         hypso75,
         hypso25,
         hypso50,
         IC,
         hydraulic_func_conn,
         area_km2 = area_km2.x,
         rc_circle = RC_CIRCLE.x,
         slope40_frac,
         brockdepmin,
         frac_recharge_area,
         avg_vbw_m,
         AVG_SAND,
         mean_dnbr, 
         AVG_CLAY,
         AVG_SILT,
         AVG_KSAT, 
         elongation = ELONGATION.x, 
         aws0150wta, 
         NDVI, 
         frac_valley,
         flow_length_m, 
         slope30_frac, 
         SP_mean,
         hypso_integral,
         year,
         frac_glacial,
         geo_coded) %>%
  mutate(site_number = as.integer(factor(site))) %>% # give each site a number
  select(-site)


```

# Exploratory mediation

No bootstrapping yet

## Stage rise

### CPF intermittent

```{r}

data <- response %>%
  # filter(fire == 'etf',
  #        sp_cat == 'low') %>%
  drop_na()

mediators <- c(
  "hypso75", 
  "hypso25", 
  "hypso50",
  "hypso_integral", 
  "IC", 
  "hydraulic_func_conn",
  "area_km2", 
  "rc_circle",
  "elongation",
  "slope40_frac",
  "slope30_frac",
  "avg_vbw_m", 
  "frac_recharge_area",
  "frac_valley", 
  "flow_length_m",
  "frac_glacial",
  "brockdepmin", 
  "AVG_SAND", 
  "AVG_CLAY", 
  "AVG_SILT", 
  "AVG_KSAT",
  "aws0150wta", 
  "mean_dnbr", 
  "SP_mean",
  "geo_coded"
)

dv <- 'stage_rise_cm'

iv <- c('MI60_mmhr',
        'lag_pwd')
        
covariates <- c('site_number',
                'year',
                'NDVI')

# run 
result <- xmed(data = data, 
               iv = iv, 
               dv = dv, 
               mediators = mediators,
               covariates = covariates,
               nfolds = 10, 
               type = 'ridge')

ivs <- names(result)[names(result) %in% c(
  'MI60_mmhr',
  'lag_pwd'
)]
    
# Combine all paths into a single tidy data frame for each resample
effect_df <- map_dfr(ivs, function(iv_name) {
      a <- result[[iv_name]]$a.coefs
      b <- result[[iv_name]]$b.coefs
      indirect <- as.numeric(result[[iv_name]]$indirect)
      mediator_names <- names(a)
      
      tibble(
        IV = iv_name,
        Mediator = mediator_names,
        a_coef = a,
        b_coef = b[mediator_names],
        weight = indirect
      )
    })
    
effect_df <- effect_df %>%
      mutate(effects = 'coefIndir') %>%
      mutate(depVar = dv)

 # make weight fill by white if 0 but keep other colors 
 effect_df_plot <- effect_df %>%
  mutate(weight_for_plot = ifelse(weight == 0, NA, weight))

ggplot(effect_df_plot, 
       aes(x = b_coef, y = Mediator)) + 
  theme_bw(base_size = 20) +
  geom_point(aes(fill = weight_for_plot,
                 color = weight_for_plot), 
             shape = 21, 
             size = 6, 
             stroke = 0.5,  # optional: makes the outline more visible
             color = 'gray50') + 
  facet_wrap(~IV) +
  labs(x = 'Direct effect size\nMediator -> DV',
       fill = 'Indirect effect size', 
       color = 'Indirect effect size') +
  paletteer::scale_color_paletteer_c("grDevices::RdYlBu", na.value = "white") +
  paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", na.value = "white") +
  ggtitle('Stage rise - ALL')

# plot
 # ggplot(effect_df, 
 #        aes(x = b_coef, y = Mediator)) + 
 #   theme_bw(base_size = 20) +
 #  geom_point(aes(fill = weight,
 #                 color = weight), 
 #             shape = 21, 
 #             size = 6, 
 #             color = 'gray50') + 
 #   facet_wrap(~IV) +
 #  labs(x = 'Direct effect size\nMediator -> DV',
 #       fill = 'Indirect effect size', 
 #       color = 'Indirect effect sizer') +
 #  paletteer::scale_color_paletteer_c("grDevices::RdYlBu") +
 #  paletteer::scale_fill_paletteer_c("grDevices::RdYlBu") +
 #   ggtitle('Stage rise - CPF intermittent')

```

