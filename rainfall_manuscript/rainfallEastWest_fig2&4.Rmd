---
title: "mrms spatial"
author: "Megan Sears"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = F,
  message = F, 
  warning  = F)

# load packages
library(here)
library(tidyverse)
library(zoo)
library(terra)
library(stars)
library(tmap)
library(sf)
library(mapview)
library(ggspatial)
library(beepr)
library(scales)

```

# Fire boundaries

```{r}
# read in fire boundaries
et <- st_read('./data/GIS/etf_updatedboundary/etf_boundary.shp') %>%
  dplyr::select(geometry)

# this is OLD ETF boundary - DO NOT USE
#et <- st_read("./data/GIS/burn_boundaries/co4020310623920201014_20200904_20210907_burn_bndy.shp")

cp <- st_read('./data/GIS/burn_boundaries/co4060910587920200813_20180915_20210907_burn_bndy.shp') %>%
  dplyr::select(geometry)

# make the et crs same as cp
et <- st_transform(et, st_crs(cp))

# bind the fires
fires <- rbind(et, cp)

# take a look
mapview(fires)

```

# Stack by year

Don't need to run anymore

```{r}
# 
# # List all the files in the directory
# filenames <- list.files("/Users/megansears/Documents/MRMS/bbox_2fires/2min_2021", pattern = ".tif", full.names = TRUE)
# 
# datetime <- list.files("/Users/megansears/Documents/MRMS/bbox_2fires/2min_2021", pattern = ".tif", full.names = F)
# 
# timestamps <- substr(datetime, 12, 26)
# datetime_seq <- ymd_hms(timestamps) - (7 * 60 * 60)
# 
# # Read all raster files and stack them together
# stack <- read_stars(filenames, along = 3)
# 
# # Set the datetime dimension of the stack
# stack_date <- st_set_dimensions(stack, 3, values = datetime_seq, names = "datetime")
# 
# # Filter the stack_date object by datetime
# stack2021 <- stack_date %>%
#   setNames('MI2_mmhr') %>%
#   mutate(p_mm =  MI2_mmhr*(1/30)) %>%
#   dplyr::select(-MI2_mmhr) %>%
#   filter(datetime > ymd_hms('2021-05-31 23:58:00'),
#          datetime < ymd_hms('2021-09-30 23:58:00'))
# 
# rm(stack, stack_date)
# 
# #save.image("/Users/megansears/Documents/Repos/post-fire_rainfall/bbox_2fires/stack_2023.RData")
# #save.image("/Users/megansears/Documents/Repos/post-fire_rainfall/bbox_2fires/stack_2022.RData")
# #save.image("/Users/megansears/Documents/Repos/post-fire_rainfall/bbox_2fires/stack_2021.RData")

```

# Filter out <0.1 mm

Don't need to run anymore

MRMS precision is 0.1

```{r}

# filter less than 1
filter_function <- function(x) {
  x[x < 0.1] <- 0
  return(x)
}

# Load your data
load('./data/mrms_data/bbox_2fires/stack_2023.RData')

# Use st_apply with future.apply for parallel processing
stack2023_fil.1 <- st_apply(
  stack2023,
  MARGIN = c("x", "y", "datetime"),
  FUN = filter_function
)

# Beep when done
beep(sound=8)

# Clean up
rm(stack2023)

save.image("./data/mrms_data/bbox_2fires/stack_2023_fil01.RData")
rm(list = ls())

# now do 2022
load("./data/mrms_data/bbox_2fires/stack_2022.RData")

# filter out values less than 1 mm
stack2022_fil.1 <- st_apply(
  stack2022,
  MARGIN = c("x", "y", "datetime"),  # dimensions
  FUN = filter_function
)
rm(stack2022)

save.image("./data/mrms_data/bbox_2fires/stack_2022_fil01.RData")

rm(list = ls())

# 2021
load("./data/mrms_data/bbox_2fires/stack_2021.RData")

# filter out values less than 1 mm 
stack2021_fil01 <- st_apply(
  stack2021,
  MARGIN = c("x", "y", "datetime"),  # dimensions
  FUN = filter_function
)
rm(stack2021)

save.image("./data/mrms_data/bbox_2fires/stack_2021_fil01.RData")

```

# Get stacks to 10 min

Don't need to run anymore

-Cut the stacks in half (left & right)
-Aggregate each pixel to 10 min
-Save as csv
-Do for left and right

## Left

```{r}
year <- 23

#load in stack
load(paste0('./data/mrms_data/bbox_2fires/stack_20', year, '_fil01.Rdata'))

# Construct the original object name
long_name <- paste0('stack20', year, '_fil.1')

# Retrieve the existing object by its name
stack <- get(long_name)

rm(list = long_name)

# set crs
st_crs(stack) <- "+proj=longlat +datum=WGS84"

# bbox of the whole area
bbox <- st_bbox(stack)

# Extract bbox coords
xmin <- bbox['xmin']
xmax <- bbox['xmax']
ymin <- bbox['ymin']
ymax <- bbox['ymax']

# Calculate mid_x
mid_x <- as.numeric(xmin + (xmax - xmin) / 2)

# bbox left site
left_bbox <- st_bbox(c(xmin = as.numeric(xmin), 
                       xmax = mid_x, 
                       ymin = as.numeric(ymin), 
                       ymax = as.numeric(ymax)), 
                     crs = st_crs(4326))

# Crop the left half
left_half <- st_crop(stack, y = left_bbox) 

rm(stack)

# make df
tibble <- as_tibble(left_half)
rm(left_half)
gc()

# aggregate to 10 min
stack10 <- tibble %>%
  mutate(datetime_round = ceiling_date(datetime, "10 mins")) %>%
  group_by(x, y, datetime_round) %>%
  rename(p_mm = filter_function) %>%
  summarize(p_mm = sum(p_mm)) %>%
  drop_na(p_mm)

write_csv(stack10, paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv'))

```

## Right 

```{r}

#load in stack
load(paste0('./data/mrms_data/bbox_2fires/stack_20', year, '_fil01.Rdata'))

# Construct the original object name
long_name <- paste0('stack20', year, '_fil01')

# Retrieve the existing object by its name
stack <- get(long_name)

rm(list = long_name)

# set crs
st_crs(stack) <- "+proj=longlat +datum=WGS84"

# bbox RIGHT site
right_bbox <- st_bbox(c(xmin = mid_x, 
                       xmax = as.numeric(xmax), 
                       ymin = as.numeric(ymin), 
                       ymax = as.numeric(ymax)), 
                     crs = st_crs(4326))

# Crop the right half
right_half <- st_crop(stack, y = right_bbox)

rm(stack)

# make df
tibble <- as_tibble(right_half)
rm(right_half)
gc()

# aggregate to 10 min
stack10 <- tibble %>%
  mutate(datetime_round = ceiling_date(datetime, "10 mins")) %>%
  group_by(x, y, datetime_round) %>%
  rename(p_mm = filter_function) %>%
  summarize(p_mm = sum(p_mm)) %>%
  drop_na(p_mm)

write_csv(stack10, paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv'))

```


# *MRMS summer totals

Includes calculations and pt of manuscript fig 2

```{r}

year <- 23 # **UPDATE HERE**

sum_all21 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2021_fil01.tif')
sum_all22 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2022_fil01.tif')
sum_all23 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2023_fil01.tif')

# make df for ggplot
p_df21<- as.data.frame(sum_all21, xy = TRUE) %>%
  rename(sum = summertotal_2021_fil01.tif) %>%
  mutate(year = 2021,
         source = 'MRMS')

p_df22<- as.data.frame(sum_all22, xy = TRUE) %>% 
  rename(sum = summertotal_2022_fil01.tif) %>%
  mutate(year = 2022,
         source = 'MRMS')
  
p_df23<- as.data.frame(sum_all23, xy = TRUE) %>%
  rename(sum = summertotal_2023_fil01.tif) %>%
  mutate(year = 2023,
         source = 'MRMS')


p_df <- bind_rows(p_df21, p_df22, p_df23)

# put in same crs
fires <- st_transform(fires, crs = 4326)

huc <- st_read('./data/GIS/WBDHU8.shp') %>%
  filter(!huc8 == 10180001) %>%
  filter(states %in% c('CO', 'CO,WY'))
  
huc8 <- st_union(huc) %>%
  st_sf()

mapview(fires) + mapview(huc8)

# Get raster extent
x_min <- min(p_df$x)
x_max <- max(p_df$x)
y_min <- min(p_df$y)
y_max <- max(p_df$y)

ptot_plot <- ggplot() +
  geom_raster(data = p_df, 
              aes(x = x, y = y, fill = sum)) +
  scale_fill_viridis_c(name = "P total (mm)", 
                       option = "turbo",
                       direction = 1,
                       limits = c(0, 610)) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey40',
          lwd = 1) +
  geom_sf(data = huc8,
          fill = NA,
          color='white',
          lwd = 1.2,
          linetype = 'dotted') +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'none',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 10,  # Adjust width of the colorbar
    barheight = 1)) 

ptot_plot

# save fig
ggsave('./figures/mrms_ptotal.svg', dpi=600, width=15, height = 20)

#############################################################################
# look at same coords with DEM
dem <- read_stars('./data/GIS/dem_10m.tif')

dem <- as.data.frame(dem)

dem_plot <- ggplot() +
  geom_raster(data = dem,
              aes(x = x, y = y, fill = dem_10m.tif)) +
  scale_fill_viridis_c(name = "elevation (m)",
                       option = "viridis",
                       direction = 1) +
                      # limits = c(0, 610)) +
  #facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey40',
          lwd = 1) +
  geom_sf(data = huc8,
          fill = NA,
          color='white',
          lwd = 1.2,
          linetype = 'dotted') +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'bottom',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.x = element_blank(),
    #axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4),
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 20,  # Adjust width of the colorbar
    barheight = 1))

dem_plot

#####################################################################
## get legend for mrms totals
ptot_legend <- ggplot() +
  geom_raster(data = p_df, 
              aes(x = x, y = y, fill = sum)) +
  scale_fill_viridis_c(name = "P total (mm)", 
                       option = "turbo",
                       direction = 1,
                       limits = c(0, 610)) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 1) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'right',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    #axis.ticks.y = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
   ) +
    guides(fill = guide_colorbar(
    barwidth = 1,  # Adjust width of the colorbar
    barheight = 10))

ptot_legend
ggsave('./figures/ptotal_legend.svg', dpi=600, width=15, height = 20)

```

# *Gridmet summer totals

Includes calculations and pt of manuscript fig 2

```{r}

gridmet21 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2021_gridmet_summerp.tif') %>%
  st_warp(., sum_all23) %>%
  as.data.frame(., xy = TRUE) %>%
  rename(sum = 3) %>%
  mutate(year = 2021,
         source = 'Gridmet')
  
#mapview(gridmet21) + mapview(sum_all21)

gridmet22 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2022_gridmet_summerp.tif') %>%
  st_warp(., sum_all23) %>%
  as.data.frame(., xy = TRUE) %>%
  rename(sum = 3) %>%
  mutate(year = 2022,
         source = 'Gridmet')

# prism23 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/prism23.ppt.tif') %>%
#   st_warp(., sum_all23) %>%
#     as.data.frame(., xy = TRUE) %>%
#   rename(sum = 3) %>%
#   mutate(year = 2023,
#          source = 'Gridmet')
# 
# mapview(prism23) + mapview(gridmet23)
# 
# test_diff <- prism23-gridmet23
# mapview(test_diff)
# 
# plot(test_diff)
# 
# # Convert raster to a data frame
# test_diff_df <- as.data.frame(test_diff,xy=T)
# 
# # Rename the value column (adjust as needed)
# names(test_diff_df)[3] <- "diff"
# 
# # Plot with ggplot2
# ggplot(test_diff_df, aes(x = x, y = y, fill = diff)) +
#   geom_raster() +
#   scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0) +
#   coord_fixed() +
#   labs(fill = "Difference")

gridmet23 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2023_gridmet_summerp.tif') %>%
  st_warp(., sum_all23) %>%
  as.data.frame(., xy = TRUE) %>%
  rename(sum = 3) %>%
  mutate(year = 2023,
         source = 'Gridmet')


gridmet_all <- bind_rows(gridmet21, gridmet22, gridmet23)

#p_combine <- bind_rows(p_df, gridmet_all)

# Get raster extent
x_min <- min(gridmet_all$x)
x_max <- max(gridmet_all$x)
y_min <- min(gridmet_all$y)
y_max <- max(gridmet_all$y)

gridmet_all_plot <- ggplot() +
  geom_raster(data = gridmet_all, 
              aes(x = x, y = y, fill = sum)) +
  scale_fill_viridis_c(name = "P total (mm)", 
                       option = "turbo",
                       direction = 1,
                       limits = c(0, 610)) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey40',
          lwd = 1) +
    theme_bw(base_size = 23) +
      geom_sf(data = huc8,
          fill = NA,
          color='white',
          lwd = 1.2,
          linetype = 'dotted') +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
  theme(
    legend.position = 'none',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_blank(),
    # strip.text = element_text(hjust = 0, 
    #                           face = "bold",
    #                           margin = margin(t = -1),
    #strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  )

gridmet_all_plot

# save fig
ggsave('./figures/ptot_gridmet_plot.svg', dpi=600, width=15, height = 20)

```

# *Mean summer RQI by year

Includes calculations and pt of manuscript fig 2

```{r}

# 2023 RQI mean
load("/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/stack_RQI_2023.RData")

rqi_mean_2023 <- st_apply(
  stack_rqi2023,
  MARGIN = c("x", "y"),
  FUN = mean
)

rqi23 <- as.data.frame(rqi_mean_2023, xy = TRUE) %>%
  mutate(year = 2023,
         source = 'RQI')

# 2022 RQI mean
load("/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/stack_RQI_2022.RData")

rqi_mean_2022 <- st_apply(
  stack_rqi2022,
  MARGIN = c("x", "y"),
  FUN = mean
)

rqi22 <- as.data.frame(rqi_mean_2022, xy = TRUE) %>%
  mutate(year = 2022,
         source = 'RQI')


# 2021 RQI mean
load("/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/stack_RQI_2021.RData")

rqi_mean_2021 <- st_apply(
  stack_rqi2021,
  MARGIN = c("x", "y"),
  FUN = mean
)

rqi21 <- as.data.frame(rqi_mean_2021, xy = TRUE) %>%
  mutate(year = 2021,
         source = 'RQI')

rqi <- bind_rows(rqi21, rqi22, rqi23)

x_min <- min(rqi$x)
x_max <- max(rqi$x)
y_min <- min(rqi$y)
y_max <- max(rqi$y)

# figure
rqi_all <- ggplot() +
  geom_raster(data = rqi, 
              aes(x = x, y = y, fill = mean)) +
  scale_fill_viridis_c(name = "Mean RQI", 
                       option = "cividis",
                       direction = 1) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey20',
          lwd = 1) +
        geom_sf(data = huc8,
          fill = NA,
          color='white',
          lwd = 1.2,
          linetype = 'dotted') +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank()) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'none',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.x = element_blank(),
    #axis.ticks.x = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 10,  # Adjust width of the colorbar
    barheight = 1))

rqi_all

# save fig
ggsave('./figures/rqi_mean_plot.svg', dpi=600, width=15, height = 20)

# create rqi legend
# figure
rqi_legend <- ggplot() +
  geom_raster(data = rqi, 
              aes(x = x, y = y, fill = mean)) +
  scale_fill_viridis_c(name = "Mean RQI", 
                       option = "cividis",
                       direction = 1) +
  facet_wrap(~as.character(year), ncol = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 1) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank()) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'right',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    #axis.ticks.y = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 1,  # Adjust width of the colorbar
    barheight = 10))

rqi_legend

ggsave('./figures/rqi_legend.png', dpi=600, width=15, height = 20)

```

# *P total above MI60 10 mm/hr

Includes calculation and pt of figure 2 in manuscript

```{r}
# year <- 23
# pover <- 10
# 
# stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
#   group_by(x,y) %>%
#   # mutate(id = cur_group_id()) %>%
#   # filter(id == 6621) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# mi60_p_23 <- bind_rows(stack10left, stack10right) %>%
#   mutate(year = 2023,
#          metric = 'MI60') 
# 
# year <- 22
# 
# stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# mi60_p_22 <- bind_rows(stack10left, stack10right) %>%
#   mutate(year = 2022,
#          metric = 'MI60')
# 
# year <- 21
# 
# stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   #mutate(sum_mm = p_mm*6) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# mi60_p_21 <- bind_rows(stack10left, stack10right) %>%
#   mutate(year = 2021,
#          metric = 'MI60')
# 
# mi60_p <- bind_rows(mi60_p_23, mi60_p_22, mi60_p_21)
# 
# write_csv(mi60_p, './data/mrms_data/bbox_2fires/mi60_pover10.csv')

mi60_p <- read_csv('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/mi60_pover10.csv')

# Get raster extent
x_min <- min(mi60_p$x)
x_max <- max(mi60_p$x)
y_min <- min(mi60_p$y)
y_max <- max(mi60_p$y)

# figure
mi60_over <- ggplot() +
  geom_raster(data = mi60_p, 
              aes(x = x, y = y, fill = p_over)) +
  scale_fill_viridis_c(name = "Total P > MI60 10 mm/hr", 
                       option = "turbo",
                       direction = 1) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey40',
          lwd = 1) +
  geom_sf(data = huc8,
          fill = NA,
          color='white',
          lwd = 1.2,
          linetype = 'dotted') +
     theme_bw(base_size=20) +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank()) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'none',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 18,  # Adjust width of the colorbar
    barheight = 1))

mi60_over

ggsave('./figures/mi60_pover10.png', dpi=600, width=15, height = 20)

# legen dfor mi60 p over
mi60_over_legend <- ggplot() +
  geom_raster(data = mi60_p, 
              aes(x = x, y = y, fill = p_over)) +
  scale_fill_viridis_c(name = "Total P > MI60 10 mm/hr", 
                       option = "turbo",
                       direction = 1) +
  facet_wrap(~as.character(year), nrow = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'grey48',
          lwd = 1) +
  geom_sf(data = huc,
          fill = NA,
          color='white',
          lwd = 0.6,
          linetype = 'dotted') +
     theme_bw(base_size=20) +
  coord_sf(xlim = c(x_min, x_max), ylim = c(y_min, y_max)) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank()) +
  theme_bw(base_size = 23) +
  theme(
    legend.position = 'right',
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    #axis.ticks.y = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),  # facet title
    strip.text = element_blank()
  ) +
  scale_x_continuous(
    breaks = seq(-106.546, -105.096, by = .4), 
    labels = function(x) paste0(round(x, 1), "°W")  # Round to 2 decimal places and add "°W"
  ) +
    guides(fill = guide_colorbar(
    barwidth = 1,  # Adjust width of the colorbar
    barheight = 10))

mi60_over_legend

ggsave('./figures/mi60_over_legend.png', dpi=600, width=15, height = 20)

```

# *Elevation vs Ptotal > threshold

Includes calculations and figure 3 in manuscript

```{r}
# read in huc, filter for co and wy
# remove one line follows the divide
# looking at the mtn range instead
huc <- st_read('./data/GIS/WBDHU8.shp') %>%
  filter(!huc8 == 10180001) %>%
  filter(states %in% c('CO', 'CO,WY'))

# make as 1 polygon  
huc8 <- st_union(huc) %>%
  st_sf()

# need to expand the dem (cut off at the bottom)
dem_add1 <- read_stars('./data/GIS/USGS_13_n40w107_20220216.tif')
dem_add2 <- read_stars('./data/GIS/USGS_13_n40w106_20230602 (1).tif')

# original dem
dem <- read_stars('./data/GIS/dem_10m.tif')

# mosaic in the bottom dems
dem_mosaic <- st_mosaic(dem, dem_add1, dem_add2)

# 2023 mi60 over 10
mi60_p10_23_rast <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/mrms2023_mi60_p10.tif')

# dem's way bigger than needed, crop to mi60_p10 rast
dem_crop <- st_crop(dem_mosaic, mi60_p10_23_rast)

# rename to dem
dem <- dem_crop

# haven't exported yet, takes a really long time
#write_stars(dem_crop,'./data/GIS/dem_10m.tif')

# need to resample DEM (10m) to match MRMS (1km)
dem_resam <- st_warp(dem, mi60_p10_23_rast, 
                     method = "bilinear",
                     use_gdal = T)

# set 0 values to NA if they exist (on border)
dem_resam[dem_resam == 0] <- NA

# crop right side of dem and create df
# only need to do this once
dem_right <- st_crop(dem_resam,
                     huc8) %>%
  as.data.frame() %>%
  rename(elev_m = 3) %>%
  drop_na(elev_m)

# right 23
# extract p over 10 mi60 for right side of mtns
pover10_mi60_right <- st_crop(mi60_p10_23_rast, 
                  huc8) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_right23 <- left_join(dem_right, pover10_mi60_right, by = c("x", "y")) %>%
  mutate(side = 'right',
         year = '2023',
         source = 'mrms')

# right 22
mi60_p10_22_rast <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/mrms2022_mi60_p10.tif')

# extract p over 10 mi60 for right side of mtns
pover10_mi60_right <- st_crop(mi60_p10_22_rast, 
                  huc8) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_right22 <- left_join(dem_right, pover10_mi60_right, by = c("x", "y")) %>%
  mutate(side = 'right',
         year = '2022',
         source = 'mrms')

# right 21
mi60_p10_21_rast <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/mrms2021_mi60_p10.tif')

# extract p over 10 mi60 for right side of mtns
pover10_mi60_right <- st_crop(mi60_p10_21_rast, 
                  huc8) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_right21 <- left_join(dem_right, pover10_mi60_right, by = c("x", "y")) %>%
  mutate(side = 'right',
         year = '2021',
         source = 'mrms')

## LEFT SIDE ##
# crop left side of dem
# this needs to be done since we are cropping area that is outside of huc8
# rasterize huc8 based on demresam, set the huc8 values to 1
# drop huc8 values (1) since we are on the left
huc8_mask <- st_rasterize(huc8, dem_resam, values = 1) %>%
  as.data.frame() %>%
  filter(!ID == 1)

# put back to stars
huc8_mask <- st_as_stars(huc8_mask, 
                                  dimensions = c("x", "y")) 

# set same crs as dem_resam
st_crs(huc8_mask) <- st_crs(dem_resam)

# crop the dem_resam to the huc8_mask
dem_left <- st_crop(dem_resam,
                     huc8_mask) %>%
  as.data.frame() %>%
  rename(elev_m = 3) %>%
  drop_na(elev_m)

# left 23
# extract p over 10 mi60 for right side of mtns
# crop by huc8mask
pover10_mi60_left <- st_crop(mi60_p10_23_rast, 
                  huc8_mask) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_left23 <- left_join(dem_left, pover10_mi60_left, by = c("x", "y")) %>%
  mutate(side = 'left',
         year = '2023',
         source = 'mrms')

# left 22
# extract p over 10 mi60 for left side of mtns
pover10_mi60_left <- st_crop(mi60_p10_22_rast, 
                  huc8_mask) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_left22 <- left_join(dem_left, pover10_mi60_left, by = c("x", "y")) %>%
  mutate(side = 'left',
         year = '2022',
         source = 'mrms')

# left 21
# extract p over 10 mi60 for left side of mtns
pover10_mi60_left <- st_crop(mi60_p10_21_rast, 
                  huc8_mask) %>%
  as.data.frame() %>%
  rename(mi60_p10 = 3) %>%
  drop_na(mi60_p10)

# join the 2 dfs
dem_p10_mi60_left21 <- left_join(dem_left, pover10_mi60_left, by = c("x", "y")) %>%
  mutate(side = 'left',
         year = '2021',
         source = 'mrms')

# combine all years and sides together
dem_p10over <- bind_rows(dem_p10_mi60_right21,
                         dem_p10_mi60_right22,
                         dem_p10_mi60_right23,
                         dem_p10_mi60_left21,
                         dem_p10_mi60_left22,
                         dem_p10_mi60_left23)

dem_p10over <- dem_p10over %>%
  mutate(
    elevation_bin = cut(
      elev_m,
      breaks = seq(1500, 4150, by = 150), # Set breaks to 150-meter intervals
      include.lowest = TRUE,
      labels = paste0(
        seq(1500, 3850, by = 150), # Start and end adjusted for 150-meter bins
        "–",
        seq(1650, 4150, by = 150)
      )
    ),
    year = as.factor(year)
  ) %>%
  separate(elevation_bin, into = c("bin_start", "bin_end"), sep = "–", convert = TRUE) %>%
  mutate(median_elev = (bin_start + bin_end) / 2)

# scatter plots of medians for each elevation bin
# get median by median_elev that represents the bin, year, side
p10over_median <- dem_p10over %>%
  group_by(median_elev, year, side) %>%
  summarize(median_p10 = median(mi60_p10)) %>%
  mutate(side = if_else(side == 'left', 'West',
                        'East'))
  
ggplot(p10over_median, aes(as.numeric(median_elev),
                median_p10,
                shape=side, color=side)) +
  geom_point(size=3,
             alpha=0.8) +
  scale_color_manual(values = c('steelblue', 'black')) +
  #geom_jitter(size=3, alpha =0.8) +
  facet_wrap(~year) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white"),
    strip.background = element_blank(),
    #strip.text = element_blank(),
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    #axis.text.x = element_text(angle = 45, hjust = 1)
    legend.position = c(.01, 0.98),
   legend.justification = c(0, 1.1), 
    legend.text = element_text(size = 13),         # Adjust legend text size
    legend.title = element_blank()
  ) +
  labs(x='Elevation (m)',
       y='Median rainfall (mm) > MI60 10 mm/hr')

ggsave('./figures/elev_vs_pixel_scatter.png', dpi=800,
       height = 6,
       width=14)

```

# *Elev stats

```{r}
# elevatioon
dem <- rast('./data/GIS/dem_10m.tif')

# cp elev
dem_cp <- extract(dem, 
                  cp,
                  xy=T)

# et elev
dem_et <- extract(dem_resam, 
                  et,
                  xy=T)

# burn boundaries
dnbr_etf <- read_stars('./data/GIS/co4020310623920201014_20200904_20210907_dnbr.tif')

dnbr_cpf <- rast(here('./data/GIS/co4060910587920200813_20180915_20210907_dnbr.tif')) %>%
  terra::project(., 'EPSG:26913')

plot(dnbr_etf)

```

# General elev stats

```{r}

# load dem
dem <- rast('./data/GIS/dem_10m.tif')

# grab the extent of the study area
extent <- rast('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2021_fil01.tif') 

# project so it's same as dem
extent <- project(extent, dem)

# crop the dem to the study area
dem_extent <- crop(dem, extent)

# read in huc8 to get crop to left and right (west and east)
huc <- st_read('./data/GIS/WBDHU8.shp') %>%
  filter(!huc8 == 10180001) %>%
  filter(states %in% c('CO', 'CO,WY'))
  
huc8 <- st_union(huc) %>%
  st_sf()

# crop to huc8 - this will be for the right (east) side
dem_right <- crop(dem_extent, huc8,
                  mask=T)

plot(dem_right)

dem_right

# change to spatvector
huc8_vect <- vect(huc8)

# Make sure CRS matches
huc8_vect <- project(huc8_vect, crs(dem_extent))

# Get DEM extent as polygon
dem_bounds <- as.polygons(ext(dem_extent), crs = crs(dem_extent))

# Erase huc8 from DEM bounds
outside_huc8 <- erase(dem_bounds, huc8_vect)

# Crop and mask DEM
dem_left <- crop(dem_extent, outside_huc8, mask = TRUE)

plot(dem_left)

dem_left

```


# *Landfire stats

```{r}

veg <- read_stars('/Users/megansears/Downloads/LF2020_BPS_220_CONUS/Tif/LC20_BPS_220.tif')

veg_cp <- st_crop(veg, cp)

mapview(veg_cp) 

veg_cpdf <- as.data.frame(veg_cp, xy=T) %>%
  drop_na() %>%
  group_by(LC20_BPS_220.tif) %>%
  summarize(sum = n()) %>%
  mutate(percent = round((sum / 939349) * 100, 2))

veg_et <- st_crop(veg, et)

veg_etdf <- as.data.frame(veg_et, xy=T) %>%
  drop_na() %>%
  group_by(LC20_BPS_220.tif) %>%
  summarize(sum = n()) %>%
  mutate(percent = round((sum / 849488) * 100, 2))

mapview(veg_et)


```

# * Spatial stats for paper

```{r}

sum_all21 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2021_fil01.tif')
sum_all22 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2022_fil01.tif')
sum_all23 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2023_fil01.tif')

# put in same crs
fires <- st_transform(fires, crs = 4326)

huc <- st_read('./data/GIS/WBDHU8.shp') %>%
  filter(!huc8 == 10180001) %>%
  filter(states %in% c('CO', 'CO,WY'))
  
huc8 <- st_union(huc) %>%
  st_sf()

huc8 <- huc8 %>% st_transform(., 4326)

sum_all21_right <- st_crop(sum_all21, huc8)
sum_all22_right <- st_crop(sum_all22, huc8)
sum_all23_right <- st_crop(sum_all23, huc8)

# left side
huc8_mask <- st_rasterize(huc8, sum_all21, values = 1) %>%
  as.data.frame() %>%
  filter(!ID == 1)

# put back to stars
huc8_mask <- st_as_stars(huc8_mask, 
                                  dimensions = c("x", "y")) 

# set same crs as dem_resam
st_crs(huc8_mask) <- st_crs(sum_all21)

sum_all21_left <- st_crop(sum_all21, huc8_mask)
sum_all22_left <- st_crop(sum_all22, huc8_mask)
sum_all23_left <- st_crop(sum_all23, huc8_mask)

# lets do the same for gridmet
gridmet21 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2021_gridmet_summerp.tif') %>%
  st_warp(., sum_all21) 

gridmet22 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2022_gridmet_summerp.tif') %>%
  st_warp(., sum_all22) 

gridmet23 <- read_stars('/Users/megansears/Documents/MRMS/mrms_data/bbox_2fires/2023_gridmet_summerp.tif') %>%
  st_warp(., sum_all23) 

grid_all21_right <- st_crop(gridmet21, huc8)
grid_all22_right <- st_crop(gridmet22, huc8)
grid_all23_right <- st_crop(gridmet23, huc8)

grid_all21_left <- st_crop(gridmet21, huc8_mask)
grid_all22_left <- st_crop(gridmet22, huc8_mask)
grid_all23_left <- st_crop(gridmet23, huc8_mask)

```


# Archive

## P over MI60 10 mm/hr - not in use

```{r}
# cpf 2023
# year <- 23
# pover <- 10
# 
# stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
#   group_by(x,y) %>%
#   arrange(datetime_round) %>% 
#   mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
#   mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
#   summarize(p_over = sum(over))
# 
# mi60_p10_23 <- bind_rows(stack10left, stack10right)
# 
# mi60_p10_23_rast <- rast(mi60_p10_23, type = "xyz")
# crs(mi60_p10_23_rast) <- "EPSG:4326" 
# 
# mi60_p10_23_rast <- project(mi60_p10_23_rast, crs(dem1))
# writeRaster(mi60_p10_23_rast, './data/mrms_data/bbox_2fires/mrms2023_mi60_p10.tif')

mi60_p10_23_rast <- rast('./data/mrms_data/bbox_2fires/mrms2023_mi60_p10.tif')

dem_resam <- resample(dem1km, mi60_p10_23_rast, method = "bilinear")

## cameron peak 23
dem_cp <- extract(dem_resam, 
                  cp,
                  xy=T)

pover10_mi60_cp <- extract(mi60_p10_23_rast, 
                  cp,
                  xy=T)

dem_p10_mi60_cp <- left_join(dem_cp, pover10_mi60_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2023',
         source = 'mrms')

ggplot(dem_p10_mi60_cp, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_boxplot() +
  ggtitle('CPF 2023') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

dem_p10_mi60_cp <- dem_p10_mi60_cp %>%
  mutate(elevation_bin = cut(USGS_13_n41w106_20230314, 
                             breaks = seq(min(USGS_13_n41w106_20230314, na.rm = TRUE), 
                                          max(USGS_13_n41w106_20230314, na.rm = TRUE), 
                                          by = 200),
                             include.lowest = TRUE,
                             labels = paste0(seq(min(USGS_13_n41w106_20230314, na.rm = TRUE), 
                                                 max(USGS_13_n41w106_20230314, na.rm = TRUE) - 100, 
                                                 by = 200), 
                                             "–", 
                                             seq(min(USGS_13_n41w106_20230314, na.rm = TRUE) + 100, 
                                                 max(USGS_13_n41w106_20230314, na.rm = TRUE), 
                                                 by = 200))))

# Plot with bins
ggplot(dem_p10_mi60_cp, aes(elevation_bin, p_over)) +
  geom_violin() +
  ggtitle('CPF 2023') +
  labs(x = 'Elevation Bin (m)', y = 'P total (mm) over MI60 10 mm/hr') +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


## 2022 cpf
year <- 22
pover <- 10

stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
  group_by(x,y) %>%
  arrange(datetime_round) %>% 
  mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
  mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
  summarize(p_over = sum(over))

stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
  group_by(x,y) %>%
  arrange(datetime_round) %>% 
  mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
  mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
  summarize(p_over = sum(over))

mi60_p10_22 <- bind_rows(stack10left, stack10right)

mi60_p10_22_rast <- rast(mi60_p10_22, type = "xyz")
crs(mi60_p10_22_rast) <- "EPSG:4326" 

mi60_p10_22_rast <- project(mi60_p10_22_rast, crs(dem1))
writeRaster(mi60_p10_22_rast, './data/mrms_data/bbox_2fires/mrms2022_mi60_p10.tif')

dem_resam <- resample(dem1km, mi60_p10_22_rast, method = "bilinear")

dem_cp <- extract(dem_resam, 
                  cp,
                  xy=T)

pover10_mi60_cp <- extract(mi60_p10_22_rast, 
                  cp,
                  xy=T)

dem_p10_mi60_cp <- left_join(dem_cp, pover10_mi60_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2022',
         source = 'mrms')

ggplot(dem_p10_mi60_cp, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_point() +
  ggtitle('CPF 2022') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

## 2021 cpf
year <- 21
pover <- 10

stack10left <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
  group_by(x,y) %>%
  arrange(datetime_round) %>% 
  mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
  mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
  summarize(p_over = sum(over))

stack10right <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
  group_by(x,y) %>%
  arrange(datetime_round) %>% 
  mutate(sum_mm = (rollapplyr(p_mm, width = 6, FUN = sum, partial = T))) %>% 
  mutate(over = if_else(sum_mm > pover, p_mm, 0)) %>%
  summarize(p_over = sum(over))

mi60_p10_21 <- bind_rows(stack10left, stack10right)

mi60_p10_21_rast <- rast(mi60_p10_21, type = "xyz")
crs(mi60_p10_21_rast) <- "EPSG:4326" 

mi60_p10_21_rast <- project(mi60_p10_21_rast, crs(dem1))
writeRaster(mi60_p10_21_rast, './data/mrms_data/bbox_2fires/mrms2021_mi60_p10.tif')

dem_resam <- resample(dem1km, mi60_p10_21_rast, method = "bilinear")

## cameron peak 21
dem_cp <- extract(dem_resam, 
                  cp,
                  xy=T)

pover10_mi60_cp <- extract(mi60_p10_21_rast, 
                  cp,
                  xy=T)

dem_p10_mi60_cp <- left_join(dem_cp, pover10_mi60_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2021',
         source = 'mrms')

ggplot(dem_p10_mi60_cp, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_point() +
  ggtitle('CPF 2021') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

## etf 2023
dem_et <- extract(dem_resam, 
                  et,
                  xy=T)

pover10_mi60_et <- extract(mi60_p10_23_rast, 
                  et,
                  xy=T)

dem_p10_mi60_et <- left_join(dem_et, pover10_mi60_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2023',
         source = 'mrms')

ggplot(dem_p10_mi60_et, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_point() +
  ggtitle('ETF 2023') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

## etf 2022
dem_et <- extract(dem_resam, 
                  et,
                  xy=T)

pover10_mi60_et <- extract(mi60_p10_22_rast, 
                  et,
                  xy=T)

dem_p10_mi60_et <- left_join(dem_et, pover10_mi60_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2022',
         source = 'mrms')

ggplot(dem_p10_mi60_et, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_point() +
  ggtitle('ETF 2022') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

## etf 2021
dem_et <- extract(dem_resam, 
                  et,
                  xy=T)

pover10_mi60_et <- extract(mi60_p10_21_rast, 
                  et,
                  xy=T)

dem_p10_mi60_et <- left_join(dem_et, pover10_mi60_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2021',
         source = 'mrms')

ggplot(dem_p10_mi60_et, aes(USGS_13_n41w106_20230314,
                         p_over)) +
  geom_point() +
  ggtitle('ETF 2021') +
  labs(y = 'P total (mm) over MI60 10 mm/hr')

```

## Annual P stats - not in use

```{r}
library(climateR)

system.time({
  gridmet_p = getGridMET(AOI = cp,
                 varname = c('pr'),
                 startDate = "2000-1-1",
                 endDate  = "2023-12-31")
})

gridmet_p <- gridmet_p[[1]] %>% # remove it from a list to just spatraster
  terra::project('EPSG:26913')



```

## Gridmet - not sure

## Monthly sums - not in use

```{r}

load('./bbox_2fires/stack_2023_fil1.Rdata')

# set crs
st_crs(stack2023_fil1) <- "+proj=longlat +datum=WGS84"

# june 2023 sum
june_stack <- stack2023_fil1 %>%
  filter(datetime > ymd_hms('2023-06-01 00:00:00'),
         datetime < ymd_hms('2023-07-01 00:00:00'))

june_sum_23 <- st_apply(
  june_stack,
  MARGIN = c("x", "y"),
  FUN = sum
)

write_stars(june_sum_23, './bbox_2fires/june_sum_23_fil1.tif')

mapview(june_sum_23) + 
  mapview(fires, col.regions = NA, col = "black", alpha.regions = 0)

# july 2023 sum
july_stack <- stack2023_fil1 %>%
  filter(datetime > ymd_hms('2023-07-01 00:00:00'),
         datetime < ymd_hms('2023-08-01 00:00:00'))

july_sum_23 <- st_apply(
  july_stack,
  MARGIN = c("x", "y"),
  FUN = sum
)

write_stars(july_sum_23, './bbox_2fires/july_sum_23_fil1.tif')

mapview(july_sum_23) + 
  mapview(fires, col.regions = NA, col = "black", alpha.regions = 0)

# august 2023 sum
aug_stack <- stack2023_fil1 %>%
  filter(datetime > ymd_hms('2023-08-01 00:00:00'),
         datetime < ymd_hms('2023-09-01 00:00:00'))

aug_sum_23 <- st_apply(
  aug_stack,
  MARGIN = c("x", "y"),
  FUN = sum
)

write_stars(aug_sum_23, './bbox_2fires/aug_sum_23_fil1.tif')

mapview(aug_sum_23) + 
  mapview(fires, col.regions = NA, col = "black", alpha.regions = 0)

# september 2023 sum
sept_stack <- stack2023_fil1 %>%
  filter(datetime > ymd_hms('2023-09-01 00:00:00'),
         datetime < ymd_hms('2023-10-01 00:00:00'))

sept_sum_23 <- st_apply(
  sept_stack,
  MARGIN = c("x", "y"),
  FUN = sum
)

write_stars(sept_sum_23, './bbox_2fires/sept_sum_23_fil1.tif')

mapview(sept_sum_23) + 
  mapview(fires, col.regions = NA, col = "black", alpha.regions = 0)


june_tibble <- as_tibble(june_sum_23) %>%
  mutate(month = 'June', year = '2023')

july_tibble <- as_tibble(july_sum_23) %>%
  mutate(month = 'July', year = '2023')

aug_tibble <- as_tibble(aug_sum_23) %>%
  mutate(month = 'August', year = '2023')

sept_tibble <- as_tibble(sept_sum_23) %>%
  mutate(month = 'September', year = '2023')

mo_sums23 <- bind_rows(june_tibble, july_tibble,
                     aug_tibble, sept_tibble) %>%
  mutate(month = as.factor(month))

# test
mo_sums_plot <- ggplot() +
  geom_raster(data = mo_sums23, 
              aes(x = x, y = y, fill = sum)) +
  scale_fill_viridis_c(name = "Monthly sums (mm)", 
                       option = "turbo",
                       direction = 1) +
  facet_wrap(~month) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 0.75) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.box.margin = margin(t = -10, r = -15, b = -10, l = -15))

mo_sums_plot

ggsave('./bbox_2fires/mo_sums_23_fil1_plot.png', dpi=600)

mo_sum_all <- bind_rows(mo_sums21, mo_sums22, mo_sums23)

# all years and months plot
mo_sums_plot <- ggplot() +
  geom_raster(data = mo_sum_all, 
              aes(x = x, y = y, fill = sum)) +
  scale_fill_viridis_c(name = "Monthly sums (mm)", 
                       option = "turbo",
                       direction = 1) +
     theme_bw(base_size=20) +
  facet_grid(rows = vars(year), cols = vars(month)) +
    # geom_sf(data = fires,
    #       fill = NA,
    #       color = 'black',
    #       lwd = 0.75) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.box.margin = margin(t = -10, r = -15, b = -10, l = -15))

mo_sums_plot

ggsave('./bbox_2fires/mo_sums_all_fil1_plot.png', dpi=600)

```

### Merge & plot -  not sure

```{r}
# read in the left and right
right <- read_stars(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_right.tif'))
left <- read_stars(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_left.tif'))

# join together
p10 <- st_mosaic(right, left)

# export
write_stars(p10, paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01.tif'))

# make df for ggplot
p_df <- as.data.frame(p10, xy = TRUE)

# put in same crs
fires <- st_transform(fires, crs = 4326)

#plot
p10_plot <- ggplot() +
  geom_raster(data = p_df, 
              aes(x = x, y = y, fill = p20_2021_fil01_right.tif)) +
  scale_fill_viridis_c(name = "P total > 20 mm/hr", 
                       option = "turbo",
                       direction = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 0.75) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank())

p10_plot

# save fig
ggsave(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_plot.png'), dpi=600)

```

## Elev vs P - not sure

## Total rain - not sure

## MRMS - not sure

```{r}

dem1 <- rast('./data/GIS/USGS_13_n41w106_20230314.tif')
dem2 <- rast('./data/GIS/USGS_13_n41w107_20230314.tif')

dem <- merge(dem1, dem2)

writeRaster(dem, './data/GIS/dem_10m.tif',
            overwrite=T)

## cameron peak 21
sum_all21 <- rast('./data/mrms_data/bbox_2fires/summertotal_2021_fil01.tif') %>%
  project(., crs(dem))

dem <- rast('./data/GIS/dem_10m.tif')

dem1km <- aggregate(dem, fact = 1000, fun = "mean")

dem_resam <- resample(dem1km, sum_all21, method = "bilinear")

## cameron peak 21
dem_cp <- extract(dem_resam, 
                  cp,
                  xy=T)

sum21_cp <- extract(sum_all21, 
                  cp,
                  xy=T)

dem_sum21_cp <- left_join(dem_cp, sum21_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2021',
         source = 'mrms') %>% 
  rename(mrms_total = 6)


ggplot(dem_sum21_cp, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point() +
  ggtitle('CPF 2021')

## cameron peak 22
sum_all22 <- rast('./data/mrms_data/bbox_2fires/summertotal_2022_fil01.tif') %>%
  project(., crs(dem1))

sum22_cp <- extract(sum_all22, 
                  cp,
                  xy=T)

dem_sum22_cp <- left_join(dem_cp, sum22_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2022',
         source = 'mrms') %>% 
  rename(mrms_total = 6)


ggplot(dem_sum22_cp, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point() +
  ggtitle('CPF 2022')

## cameron peak 23
sum_all23 <- rast('./data/mrms_data/bbox_2fires/summertotal_2023_fil01.tif') %>%
  project(., crs(dem1))

sum23_cp <- extract(sum_all23, 
                  cp,
                  xy=T)

dem_sum23_cp <- left_join(dem_cp, sum23_cp, by = c("x", "y")) %>%
  mutate(fire = 'cp',
         year = '2023',
         source = 'mrms') %>%
  rename(mrms_total = 6)


ggplot(dem_sum23_cp, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point() +
  ggtitle('CPF 2023')

## etf 2021
dem_et <- extract(dem_resam, 
                  et,
                  xy=T)

sum_all21 <- rast('./data/mrms_data/bbox_2fires/summertotal_2021_fil01.tif') %>%
  project(., crs(dem1))

sum21_et <- extract(sum_all21, 
                  et,
                  xy=T)

dem_sum21_et <- left_join(dem_et, sum21_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2021',
         source = 'mrms') %>% 
  rename(mrms_total = 6)


ggplot(dem_sum21_et, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point() +
  ggtitle('ETF 2021')

## etf 2022
sum_all22 <- rast('./data/mrms_data/bbox_2fires/summertotal_2022_fil01.tif') %>%
  project(., crs(dem1))

sum22_et <- extract(sum_all22, 
                  et,
                  xy=T)

dem_sum22_et <- left_join(dem_et, sum22_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2022',
         source = 'mrms') %>% 
  rename(mrms_total = 6)


ggplot(dem_sum22_et, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point()

## etf 2023
sum_all23 <- rast('./data/mrms_data/bbox_2fires/summertotal_2023_fil01.tif') %>%
  project(., crs(dem1))

sum23_et <- extract(sum_all23, 
                  et,
                  xy=T)

dem_sum23_et <- left_join(dem_et, sum23_et, by = c("x", "y")) %>%
  mutate(fire = 'et',
         year = '2023',
         source = 'mrms') %>% 
  rename(mrms_total = 6)

ggplot(dem_sum23_et, aes(USGS_13_n41w106_20230314,
                         mrms_total)) +
  geom_point()

## join all for mrms
dem_mrms <- bind_rows(dem_sum21_cp,
                      dem_sum22_cp,
                      dem_sum23_cp,
                      dem_sum21_et,
                      dem_sum22_et,
                      dem_sum23_et)

ggplot(dem_mrms, aes(USGS_13_n41w106_20230314,
                     mrms_total)) +
  geom_point() +
  facet_wrap(~fire + year)

```

## MI60 - not in use

The stack (or tibble) is too large, exhausts memory. The raster stacks need to be cut in half down the middle.

### Left half first

```{r}

year <- 21

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv'))

# calculates max MI60 over a summer
compute_MI60 <- function(df) {
  # Calculate the rolling sum over 6 intervals (60 minutes)
  rolling_sums <- rollapply(df, width = 6, FUN = sum, na.rm = TRUE, fill = NA, align = "right")
  # Find the max of rolling sums
  max(rolling_sums, na.rm = TRUE)
}

# Calculate MI60 for each pixel over the 10-min data
stack_mi60 <- stack10 %>%
  group_by(x, y) %>%
  arrange(datetime_round) %>%
  mutate(MI60 = compute_MI60(p_mm)) %>%
  summarize(maxMI60 = max(MI60, na.rm = TRUE))

# convert back to stars
stack_intens.1 <- st_as_stars(stack_mi60, dims = c("x", "y"))

# set the crs
st_crs(stack_intens.1) <- st_crs("+proj=longlat +datum=WGS84")

# export as tif
write_stars(stack_intens.1, paste0('./data/mrms_data/bbox_2fires/mi60_', year, '_left01.tif'))

# remove old objects
rm(stack_intens.1, stack10, stack_mi60)

```

### Right half

```{r}

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv'))

# Calculate MI60 for each pixel over 10-min timesteps
stack_mi60 <- stack10 %>%
  group_by(x, y) %>%
  arrange(datetime_round) %>%
  mutate(MI60 = compute_MI60(p_mm)) %>%
  summarize(maxMI60 = max(MI60, na.rm = TRUE))

# convert back to stars
stack_intens.1 <- st_as_stars(stack_mi60, dims = c("x", "y"))

# set the crs
st_crs(stack_intens.1) <- st_crs("+proj=longlat +datum=WGS84")

#export as tif
write_stars(stack_intens.1, paste0('./data/mrms_data/bbox_2fires/mi60_', year, '_right01.tif'))

# remove old objects
rm(stack_intens.1, stack10, stack_mi60)

```

### Merge left & right together

```{r}

# read in the left and right
right <- read_stars(paste0('./data/mrms_data/bbox_2fires/mi60_', year, '_right01.tif'))
left <- read_stars(paste0('./data/mrms_data/bbox_2fires/mi60_', year, '_left01.tif'))

# join together
mi60 <- st_mosaic(right, left)

# export as tif
write_stars(mi60, paste0('./data/mrms_data/bbox_2fires/mi60_', year, 'mi60_01.tif'))

# make df for ggplot geom_raster
mi60_df <- as.data.frame(mi60, xy = TRUE)

# put in same crs
fires <- st_transform(fires, crs = 4326)

# plot
mi60_plot <- ggplot() +
  geom_raster(data = mi60_df, 
              aes(x = x, y = y, fill = mi60_21_right01.tif)) +
  scale_fill_viridis_c(name = "MI60 (mm/hr)", 
                       option = "turbo",
                       direction = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 0.75) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank())

mi60_plot

# save fig
ggsave(paste0('./data/mrms_data/bbox_2fires/mi60_20', year, '_mi60_01_plot.png'), dpi=600)

```

## Count of pixels > 10 mm/hr for MI10 - not in use

- Split left and right halves
- Aggregate to 10 mins
- 10 min data (mm) to mm/hr
- Counts of MI10 above 10 mm/hr

### Left

```{r}

year <- 21

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
  mutate(p_mmhr = p_mm*6) %>%
  select(-p_mm) %>%
  mutate(count10 = if_else(p_mmhr > 20, 1 , 0)) %>%
  select(-p_mmhr) %>%
  group_by(x,y) %>%
  summarize(sum10 = sum(count10))

# convert back to stars
stack_count10 <- st_as_stars(stack10, dims = c("x", "y"))

# set the crs
st_crs(stack_count10) <- st_crs("+proj=longlat +datum=WGS84")

#export as tif
write_stars(stack_count10, paste0('./data/mrms_data/bbox_2fires/count20_20', year, '_fil01_left.tif'))

rm(stack_count10, stack10)

beep(sound=8)

```

### Right

```{r}

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
  mutate(p_mmhr = p_mm*6) %>%
  select(-p_mm) %>%
  mutate(count10 = if_else(p_mmhr > 20, 1 , 0)) %>%
  select(-p_mmhr) %>%
  group_by(x,y) %>%
  summarize(sum10 = sum(count10))

# convert back to stars
stack_count10 <- st_as_stars(stack10, dims = c("x", "y"))

# set the crs
st_crs(stack_count10) <- st_crs("+proj=longlat +datum=WGS84")

#export as tif
write_stars(stack_count10, paste0('./data/mrms_data/bbox_2fires/count20_20', year, '_fil01_right.tif')) 

rm(stack_count10, stack10)

beep(sound=8)

```

### Merge & plot

```{r}
# read in the left and right
right <- read_stars(paste0('./data/mrms_data/bbox_2fires/count20_20', year, '_fil01_right.tif'))
left <- read_stars(paste0('./data/mrms_data/bbox_2fires/count20_20', year, '_fil01_left.tif'))

# join together
count10 <- st_mosaic(right, left)

# export
write_stars(count10, paste0('./data/mrms_data/bbox_2fires/count_20', year, '_fil01.tif'))

# make df for ggplot
count_df <- as.data.frame(count10, xy = TRUE)

# put in same crs
fires <- st_transform(fires, crs = 4326)

#plot
count_plot <- ggplot() +
  geom_raster(data = count_df, 
              aes(x = x, y = y, fill = count20_2021_fil01_right.tif)) +
  scale_fill_viridis_c(name = "Count > 20 mm/hr", 
                       option = "turbo",
                       direction = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 0.75) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank())

count_plot

# save fig
ggsave(paste0('./data/mrms_data/bbox_2fires/count20_20', year, '_fil01_plot.png'), dpi=600)

```

## P total above 10 mm/hr - not in use

### Left

```{r}

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_left.csv')) %>% 
  mutate(p_mmhr = p_mm*6) %>%
  mutate(p_10 = if_else(p_mmhr > 20, p_mm, 0)) %>%
  group_by(x,y) %>%
  summarize(p10_sum = sum(p_10))

# convert back to stars
stack_p10 <- st_as_stars(stack10, dims = c("x", "y"))

# set the crs
st_crs(stack_p10) <- st_crs("+proj=longlat +datum=WGS84")

mapview(stack_p10)

#export as tif
write_stars(stack_p10, paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_left.tif'))
rm(stack_p10, stack10)

#beep(sound=8)

```

### Right

```{r}

stack10 <- read_csv(paste0('./data/mrms_data/bbox_2fires/mrms20', year, '_10min_right.csv')) %>% 
  mutate(p_mmhr = p_mm*6) %>%
  mutate(p_10 = if_else(p_mmhr > 20, p_mm, 0)) %>%
  group_by(x,y) %>%
  summarize(p10_sum = sum(p_10))

# convert back to stars
stack_p10 <- st_as_stars(stack10, dims = c("x", "y"))

# set the crs
st_crs(stack_p10) <- st_crs("+proj=longlat +datum=WGS84")

mapview(stack_p10)

#export as tif
write_stars(stack_p10, paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_right.tif'))
rm(stack_p10, stack10)

beep(sound=8)

```

### Merge & plot

```{r}
# read in the left and right
right <- read_stars(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_right.tif'))
left <- read_stars(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_left.tif'))

# join together
p10 <- st_mosaic(right, left)

# export
write_stars(p10, paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01.tif'))

# make df for ggplot
p_df <- as.data.frame(p10, xy = TRUE)

# put in same crs
fires <- st_transform(fires, crs = 4326)

#plot
p10_plot <- ggplot() +
  geom_raster(data = p_df, 
              aes(x = x, y = y, fill = p20_2021_fil01_right.tif)) +
  scale_fill_viridis_c(name = "P total > 20 mm/hr", 
                       option = "turbo",
                       direction = 1) +
  geom_sf(data = fires,
          fill = NA,
          color = 'black',
          lwd = 0.75) +
     theme_bw(base_size=20) +
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank())

p10_plot

# save fig
ggsave(paste0('./data/mrms_data/bbox_2fires/p20_20', year, '_fil01_plot.png'), dpi=600)

```
