---
title: "pull PRISM 800m"
author: "Megan Sears"
date: "`r Sys.Date()`"
output: html_document
---

```{r}

library(tidyverse)
library(httr)
library(terra)

```

# Function to pull PRISM 800m

```{r}

get_prism800 <- function(url, outdir) {
  
  fname_date <- gsub(".*/", "", url) # date from URL
  var <- "ppt" # precip
  region <- "us" # CONUS
  res <- "800m" # 800 m 
  
  # File paths
  fname_base <- paste(var, 
                      region, 
                      res, 
                      fname_date, 
                      sep = "_")
  
  zipfile <- file.path(outdir, 
                       paste0(fname_base, 
                              ".zip"))
  
  unzipdir <- file.path(outdir, 
                        paste0(fname_base, 
                               "_unzipped"))
  
  # Download ZIP
  resp <- GET(url, write_disk(zipfile, 
                              overwrite = TRUE), 
              progress())
  
  if (http_error(resp)) stop("Download failed: ", url)
  
  # Unzip
  unzip(zipfile, exdir = unzipdir)
  
  # Find the raster inside the ZIP (.tif)
  raster_file <- list.files(unzipdir, pattern = "\\.tif$", full.names = TRUE)[1]
  if (is.na(raster_file)) stop("No raster found in ZIP for ", fname_date)
  
  # Read raster
  rast(raster_file)
}

```


```{r}

# This is mrms summer 23 data
# Used for crs and extent later on
sum_all23 <- rast('~/Documents/MRMS/mrms_data/bbox_2fires/summertotal_2023_fil01.tif')

# Folder to save downloads
outdir <- "~/Documents/PRISM800/JJAS23"

# Date range for function
dates_tbl <- tibble(
  date = seq(ymd("2023-06-01"), 
             ymd("2023-09-30"), 
             by = "day")) %>%
  mutate(date_str = format(date, 
                           "%Y%m%d"),
    url = paste0("https://services.nacse.org/prism/data/get/us/800m/ppt/", 
                 date_str))

# Run the function w/ urls
rasters <- dates_tbl %>%
  pull(url) %>%
  map(~ get_prism800(.x, outdir))

# Stack into a single SpatRaster
P_prism_stack <- rast(rasters)

# Sum for JJAS total - this is CONUS
prismSum <- sum(P_prism_stack, 
                na.rm = TRUE)

# Project  
prism_proj <- project(prismSum,
                      "EPSG:4326") # matches sum_all23

# Crop to mrms summer total for figure
prismJJAS22 <- crop(prism_proj,
                    sum_all23)

plot(prismJJAS22)

writeRaster(prismJJAS22,
            '~/Documents/PRISM800/JJAS22/prism800mJJAS2022.tif')

```
